---
- name: Esegui lo script di backup con log in tempo reale
  hosts: all
  gather_facts: no
  strategy: free

  vars:
    script_path: "{{ script_path }}"  # Variabile passata da Semaphore
    log_file: /tmp/backup.log

  tasks:
    - name: Esegui backup come root con log timestamped
      ansible.builtin.shell: |
        sudo bash -c '{
          while IFS= read -r line; do
            timestamped_line="$(date "+%Y-%m-%d %H:%M:%S") $line"
            echo "$timestamped_line" | sudo tee -a {{ log_file }}
          done < <({{ script_path }})
        }'
      args:
        executable: /bin/bash
